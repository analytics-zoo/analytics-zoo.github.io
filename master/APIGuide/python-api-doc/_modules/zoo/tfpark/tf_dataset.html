
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>zoo.tfpark.tf_dataset &#8212; analytics-zoo  documentation</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">analytics-zoo  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../tfpark.html" accesskey="U">zoo.tfpark</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for zoo.tfpark.tf_dataset</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright 2018 Analytics Zoo Authors.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">pyspark.ml.linalg</span> <span class="kn">import</span> <span class="n">DenseVector</span><span class="p">,</span> <span class="n">SparseVector</span><span class="p">,</span> <span class="n">VectorUDT</span>
<span class="kn">from</span> <span class="nn">bigdl.transform.vision.image</span> <span class="kn">import</span> <span class="n">FeatureTransformer</span>
<span class="kn">from</span> <span class="nn">bigdl.util.common</span> <span class="kn">import</span> <span class="n">get_node_and_core_number</span>
<span class="kn">from</span> <span class="nn">zoo.common.utils</span> <span class="kn">import</span> <span class="n">callZooFunc</span>
<span class="kn">from</span> <span class="nn">zoo.common</span> <span class="kn">import</span> <span class="n">Sample</span><span class="p">,</span> <span class="n">JTensor</span>
<span class="kn">from</span> <span class="nn">zoo.common.nncontext</span> <span class="kn">import</span> <span class="n">getOrCreateSparkContext</span>
<span class="kn">from</span> <span class="nn">zoo.feature.common</span> <span class="kn">import</span> <span class="n">FeatureSet</span><span class="p">,</span> <span class="n">SampleToMiniBatch</span><span class="p">,</span> <span class="n">Preprocessing</span>
<span class="kn">from</span> <span class="nn">zoo.feature.image</span> <span class="kn">import</span> <span class="n">ImagePreprocessing</span><span class="p">,</span> <span class="n">ImageFeatureToSample</span>
<span class="kn">from</span> <span class="nn">zoo.util</span> <span class="kn">import</span> <span class="n">nest</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
    <span class="n">long</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="n">unicode</span> <span class="o">=</span> <span class="nb">str</span>


<span class="k">def</span> <span class="nf">_to_tensor_structure</span><span class="p">(</span><span class="n">tensors</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">tensor_structure</span> <span class="o">=</span> <span class="n">TensorMeta</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="n">tensors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input0&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">tensor_structure</span> <span class="o">=</span> <span class="p">[</span><span class="n">TensorMeta</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="n">name</span><span class="o">=</span><span class="s2">&quot;list_input_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
                            <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tensors</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">tensor_structure</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tensors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tensor_structure</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">TensorMeta</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;In TFDataset.from_rdd, features and labels should be a tuple, &quot;</span>
                         <span class="s2">&quot;a list of tuples or a dict of tuples&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tensor_structure</span>


<span class="k">def</span> <span class="nf">_tensors_to_rdd</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">splits</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">tensors</span> <span class="o">=</span> <span class="p">(</span><span class="n">tensors</span><span class="p">,)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tensors</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">tensors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">):</span>
                <span class="n">tensors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">tensors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">data_list</span> <span class="o">=</span> <span class="n">_splits</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">splits</span><span class="p">)</span>
        <span class="n">tensor_structure</span> <span class="o">=</span> <span class="p">[</span><span class="n">TensorMeta</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">as_dtype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                                       <span class="n">shape</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                                       <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tensors</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flattened</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flattened</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">flattened</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">):</span>
                <span class="n">flattened</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">flattened</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="n">_splits</span><span class="p">(</span><span class="n">flattened</span><span class="p">)</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">splits</span><span class="p">)</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">nest</span><span class="o">.</span><span class="n">pack_sequence_as</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
        <span class="n">tensor_structure</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">pack_sequence_as</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span>
                                                 <span class="p">[</span><span class="n">TensorMeta</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">as_dtype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                                                             <span class="n">shape</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                                                             <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                                                  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">flattened</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">rdd</span><span class="p">,</span> <span class="n">tensor_structure</span>


<span class="k">def</span> <span class="nf">_splits</span><span class="p">(</span><span class="n">tensors</span><span class="p">):</span>
    <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_size</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data_size</span><span class="p">):</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tensors</span><span class="p">)):</span>
            <span class="n">sample</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensors</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_list</span>


<div class="viewcode-block" id="MergeFeatureLabelImagePreprocessing"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.MergeFeatureLabelImagePreprocessing">[docs]</a><span class="k">class</span> <span class="nc">MergeFeatureLabelImagePreprocessing</span><span class="p">(</span><span class="n">ImagePreprocessing</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MergeFeatureLabelImagePreprocessing</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">bigdl_type</span><span class="p">)</span></div>


<div class="viewcode-block" id="MergeFeatureLabelFeatureTransformer"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.MergeFeatureLabelFeatureTransformer">[docs]</a><span class="k">class</span> <span class="nc">MergeFeatureLabelFeatureTransformer</span><span class="p">(</span><span class="n">FeatureTransformer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MergeFeatureLabelFeatureTransformer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">bigdl_type</span><span class="p">)</span></div>


<div class="viewcode-block" id="TensorMeta"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TensorMeta">[docs]</a><span class="k">class</span> <span class="nc">TensorMeta</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span></div>


<div class="viewcode-block" id="TFDataset"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset">[docs]</a><span class="k">class</span> <span class="nc">TFDataset</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        TFDataset represents a distributed collection of elements (backed by a RDD)</span>
<span class="sd">        to be feed into Tensorflow graph.</span>

<span class="sd">        :param tensor_structure: a nested structure of TensorMeta objects specifying the</span>
<span class="sd">        name, shape and data type of each element in this TFDataset</span>
<span class="sd">        :param batch_size: the batch size, used for training, should be a multiple of</span>
<span class="sd">        total core num</span>
<span class="sd">        :param batch_per_thread: the batch size for each thread, used for inference or evaluation</span>
<span class="sd">        :param hard_code_batch_size: whether to hard code the batch_size into tensorflow graph,</span>
<span class="sd">        if True, the static size of the first dimension of the resulting tensors is</span>
<span class="sd">        batch_size/total_core_num (training) or batch_per_thread for inference; if False,</span>
<span class="sd">        it is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">batch_per_thread</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bath_size and batch_per_thread should not be set simultaneously&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">has_batch</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">node_num</span><span class="p">,</span> <span class="n">core_num</span> <span class="o">=</span> <span class="n">get_node_and_core_number</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_core_num</span> <span class="o">=</span> <span class="n">node_num</span> <span class="o">*</span> <span class="n">core_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_num</span> <span class="o">=</span> <span class="n">node_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core_num</span> <span class="o">=</span> <span class="n">core_num</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">batch_size</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_core_num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;batch_size should be a multiple &quot;</span> <span class="o">+</span>
                                 <span class="s2">&quot;of total core number, but got batch_size: &quot;</span> <span class="o">+</span>
                                 <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> where total core number is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span>
                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">total_core_num</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">batch_per_thread</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">batch_per_thread</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_core_num</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_batch</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_per_thread</span> <span class="o">=</span> <span class="n">batch_per_thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hard_code_batch_size</span> <span class="o">=</span> <span class="n">hard_code_batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span> <span class="o">=</span> <span class="n">tensor_structure</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hard_code_batch_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_shapes</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">pack_sequence_as</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span><span class="p">,</span> <span class="p">[[</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_per_thread</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_shapes</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">pack_sequence_as</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span><span class="p">,</span> <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_per_thread</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span>
                                            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                                            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_shapes</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">pack_sequence_as</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span><span class="p">,</span> <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_core_num</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                                            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span><span class="p">)])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_names</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">pack_sequence_as</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">name</span>
                                    <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span><span class="p">)])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tensors</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_create_placeholders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hard_code_batch_size</span><span class="p">:</span>
            <span class="n">tensors</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">pack_sequence_as</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span><span class="p">,</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                       <span class="n">dtype</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                                       <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_per_thread</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tensors</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">pack_sequence_as</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                    <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_per_thread</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                     <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tensors</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">pack_sequence_as</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                    <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_core_num</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                     <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span><span class="p">)])</span>

        <span class="k">for</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">tensors</span><span class="p">):</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">clear_collection</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">add_to_collection</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_original_tensors</span> <span class="o">=</span> <span class="n">tensors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tensors</span> <span class="o">=</span> <span class="n">tensors</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_batch</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tensors</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">pack_sequence_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_structure</span><span class="p">,</span>
                                                  <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">tensors</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">tensors</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        a nested structure of TensorFlow tensor object in TensorFlow graph.</span>
<span class="sd">        The elements of this dataset will be fed into these tensors on each iteration.</span>
<span class="sd">        :return: the nested structure of TensorFlow tensor object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_placeholders</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensors</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">feature_tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_placeholders</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tensors</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;To use feature_tensors, &quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;the element in TFDataset must be a tuple of two components. &quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;Please use TFDataset.from_rdd(rdd, features=..., labels=...). &quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">label_tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_placeholders</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tensors</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;To use label_tensors, &quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;the element in TFDataset must be a tuple of two components. &quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;Please use TFDataset.from_rdd(rdd, features=..., labels=...). &quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_to_tensor_structure</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">feature_structure</span> <span class="o">=</span> <span class="n">_to_tensor_structure</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label_structure</span> <span class="o">=</span> <span class="n">_to_tensor_structure</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">tensor_structure</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature_structure</span><span class="p">,</span> <span class="n">label_structure</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">tensor_structure</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature_structure</span><span class="p">,)</span>
        <span class="k">return</span> <span class="n">tensor_structure</span>

<div class="viewcode-block" id="TFDataset.get_prediction_data"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset.get_prediction_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_prediction_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: an object that can be used for TFNet.predict</span>
<span class="sd">        e.g. an RDD of Sample or a ImageSet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_per_thread</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;batch_per_thread must be set when used in prediction&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prediction_data</span><span class="p">()</span></div>

<div class="viewcode-block" id="TFDataset.get_evaluation_data"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset.get_evaluation_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_evaluation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: an object that can be used for TFNet.evaluate,</span>
<span class="sd">        e.g. an RDD of Sample or a ImageSet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_per_thread</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;batch_per_thread must be set when used in evaluation&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_evaluation_data</span><span class="p">()</span></div>

<div class="viewcode-block" id="TFDataset.get_training_data"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset.get_training_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: an object that can be used to create a BigDL optimizer,</span>
<span class="sd">        e.g. an RDD of Sample or a DataSet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;batch_size must be set when used in training&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_training_data</span><span class="p">()</span></div>

<div class="viewcode-block" id="TFDataset.get_validation_data"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset.get_validation_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_validation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: an object that can be used to set validation in a BigDL optimizer,</span>
<span class="sd">        e.g. an RDD of Sample or a DataSet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;batch_size must be set when used in training&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_validation_data</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_prediction_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_get_evaluation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_get_training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_get_validation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="TFDataset.get_num_partitions"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset.get_num_partitions">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_partitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: the num of partitions of the underlying RDD</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="TFDataset.from_rdd"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset.from_rdd">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_rdd</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a TFDataset from a rdd.</span>

<span class="sd">        For training and evaluation, both `features` and `labels` arguments should be specified.</span>
<span class="sd">        The element of the rdd should be a tuple of two, (features, labels), each has the</span>
<span class="sd">        same structure of numpy.ndarrays of the argument `features`, `labels`.</span>

<span class="sd">        E.g. if `features` is [(tf.float32, [10]), (tf.float32, [20])],</span>
<span class="sd">        and `labels` is {&quot;label1&quot;:(tf.float32, [10]), &quot;label2&quot;: (tf.float32, [20])}</span>
<span class="sd">        then a valid element of the rdd could be</span>

<span class="sd">        (</span>
<span class="sd">        [np.zeros(dtype=float, shape=(10,), np.zeros(dtype=float, shape=(10,)))],</span>
<span class="sd">         {&quot;label1&quot;: np.zeros(dtype=float, shape=(10,)),</span>
<span class="sd">          &quot;label2&quot;:np.zeros(dtype=float, shape=(10,))))}</span>
<span class="sd">        )</span>

<span class="sd">        If `labels` is not specified,</span>
<span class="sd">        then the above element should be changed to</span>
<span class="sd">        [np.zeros(dtype=float, shape=(10,), np.zeros(dtype=float, shape=(10,)))]</span>

<span class="sd">        For inference, `labels` can be not specified.</span>
<span class="sd">        The element of the rdd should be some ndarrays of the same structure of the `features`</span>
<span class="sd">        argument.</span>

<span class="sd">        A note on the legacy api: if you are using `names`, `shapes`, `types` arguments,</span>
<span class="sd">        each element of the rdd should be a list of numpy.ndarray.</span>

<span class="sd">        :param rdd: a rdd containing the numpy.ndarrays to be used</span>
<span class="sd">        for training/evaluation/inference</span>
<span class="sd">        :param features: the structure of input features, should one the following:</span>
<span class="sd">               - a tuple (dtype, shape), e.g. (tf.float32, [28, 28, 1])</span>
<span class="sd">               - a list of such tuple [(dtype1, shape1), (dtype2, shape2)],</span>
<span class="sd">                     e.g. [(tf.float32, [10]), (tf.float32, [20])],</span>
<span class="sd">               - a dict of such tuple, mapping string names to tuple {&quot;name&quot;: (dtype, shape},</span>
<span class="sd">                     e.g. {&quot;input1&quot;:(tf.float32, [10]), &quot;input2&quot;: (tf.float32, [20])}</span>

<span class="sd">        :param labels: the structure of input labels, format is the same as features</span>
<span class="sd">        :param batch_size: the batch size, used for training, should be a multiple of</span>
<span class="sd">        total core num</span>
<span class="sd">        :param batch_per_thread: the batch size for each thread, used for inference or evaluation</span>
<span class="sd">        :param hard_code_batch_size: whether to hard code the batch_size into tensorflow graph,</span>
<span class="sd">        if True, the static size of the first dimension of the resulting tensors is</span>
<span class="sd">        batch_size/total_core_num (training) or batch_per_thread for inference; if False,</span>
<span class="sd">        it is None.</span>
<span class="sd">        :param val_rdd: validation data with the same structure of rdd</span>
<span class="sd">        :param sequential_order: whether to iterate the elements in the Dataset</span>
<span class="sd">                                 in sequential order when training.</span>
<span class="sd">        :param shuffle: whether to shuffle the elements in each partition before each epoch</span>
<span class="sd">                        when training</span>
<span class="sd">        :return: a TFDataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TFNdarrayDataset</span><span class="o">.</span><span class="n">from_rdd</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TFDataset.from_ndarrays"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset.from_ndarrays">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_ndarrays</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a TFDataset from a nested structure of numpy ndarrays. Each element</span>
<span class="sd">        in the resulting TFDataset has the same structure of the argument tensors and</span>
<span class="sd">        is created by indexing on the first dimension of each ndarray in the tensors</span>
<span class="sd">        argument.</span>

<span class="sd">        This method is equivalent to sc.parallize the tensors and call TFDataset.from_rdd</span>

<span class="sd">        :param tensors: the numpy ndarrays</span>
<span class="sd">        :param batch_size: the batch size, used for training, should be a multiple of</span>
<span class="sd">        total core num</span>
<span class="sd">        :param batch_per_thread: the batch size for each thread, used for inference or evaluation</span>
<span class="sd">        :param hard_code_batch_size: whether to hard code the batch_size into tensorflow graph,</span>
<span class="sd">        if True, the static size of the first dimension of the resulting tensors is</span>
<span class="sd">        batch_size/total_core_num (training) or batch_per_thread for inference; if False,</span>
<span class="sd">        it is None.</span>
<span class="sd">        :param val_tensors: the numpy ndarrays used for validation during training</span>
<span class="sd">        :param sequential_order: whether to iterate the elements in the Dataset</span>
<span class="sd">                                 in sequential order when training.</span>
<span class="sd">        :param shuffle: whether to shuffle the elements in each partition before each epoch</span>
<span class="sd">                        when training</span>
<span class="sd">        :return: a TFDataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TFNdarrayDataset</span><span class="o">.</span><span class="n">from_ndarrays</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TFDataset.from_image_set"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset.from_image_set">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_image_set</span><span class="p">(</span><span class="n">image_set</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_per_thread</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">validation_image_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">sequential_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a TFDataset from a ImagetSet. Each ImageFeature in the ImageSet should</span>
<span class="sd">        already has the &quot;sample&quot; field, i.e. the result of ImageSetToSample transformer</span>

<span class="sd">        :param image_set: the ImageSet used to create this TFDataset</span>
<span class="sd">        :param image: a tuple of two, the first element is the type of image, the second element</span>
<span class="sd">        is the shape of this element, i.e. (tf.float32, [224, 224, 3]))</span>
<span class="sd">        :param label: a tuple of two, the first element is the type of label, the second element</span>
<span class="sd">        is the shape of this element, i.e. (tf.int32, [1]))</span>
<span class="sd">        :param batch_size: the batch size, used for training, should be a multiple of</span>
<span class="sd">        total core num</span>
<span class="sd">        :param batch_per_thread: the batch size for each thread, used for inference or evaluation</span>
<span class="sd">        :param hard_code_batch_size: whether to hard code the batch_size into tensorflow graph,</span>
<span class="sd">        if True, the static size of the first dimension of the resulting tensors is</span>
<span class="sd">        batch_size/total_core_num (training) or batch_per_thread for inference; if False,</span>
<span class="sd">        it is None.</span>
<span class="sd">        :param validation_image_set: the ImageSet used for validation during training</span>
<span class="sd">        :param sequential_order: whether to iterate the elements in the Dataset</span>
<span class="sd">                                 in sequential order when training.</span>
<span class="sd">        :param shuffle: whether to shuffle the elements in each partition before each epoch</span>
<span class="sd">                        when training</span>
<span class="sd">        :return: a TFDataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tensor_structure</span> <span class="o">=</span> <span class="n">TFDataset</span><span class="o">.</span><span class="n">_to_tensor_structure</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TFImageDataset</span><span class="p">(</span><span class="n">image_set</span><span class="p">,</span> <span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                              <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="p">,</span>
                              <span class="n">validation_image_set</span><span class="p">,</span>
                              <span class="n">sequential_order</span><span class="o">=</span><span class="n">sequential_order</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">)</span></div>

<div class="viewcode-block" id="TFDataset.from_text_set"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset.from_text_set">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_text_set</span><span class="p">(</span><span class="n">text_set</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_per_thread</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">validation_image_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">sequential_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a TFDataset from a TextSet. The TextSet must be transformed to Sample, i.e.</span>
<span class="sd">        the result of TextFeatureToSample transformer.</span>
<span class="sd">        :param text_set: the TextSet used to create this TFDataset</span>
<span class="sd">        :param text: a tuple of two, the first element is the type of this input feature,</span>
<span class="sd">        the second element is the shape of this element, i.e. (tf.float32, [10, 100, 4])).</span>
<span class="sd">        text can also be nested structure of this tuple of two.</span>
<span class="sd">        :param label: a tuple of two, the first element is the type of label, the second element</span>
<span class="sd">        is the shape of this element, i.e. (tf.int32, [1])). label can also be nested structure of</span>
<span class="sd">        this tuple of two.</span>
<span class="sd">        :param batch_size: the batch size, used for training, should be a multiple of</span>
<span class="sd">        total core num</span>
<span class="sd">        :param batch_per_thread: the batch size for each thread, used for inference or evaluation</span>
<span class="sd">        :param hard_code_batch_size: whether to hard code the batch_size into tensorflow graph,</span>
<span class="sd">        if True, the static size of the first dimension of the resulting tensors is</span>
<span class="sd">        batch_size/total_core_num (training) or batch_per_thread for inference; if False,</span>
<span class="sd">        it is None.</span>
<span class="sd">        :param validation_image_set: The TextSet used for validation during training</span>
<span class="sd">        :param sequential_order: whether to iterate the elements in the Dataset</span>
<span class="sd">                                 in sequential order when training.</span>
<span class="sd">        :param shuffle: whether to shuffle the elements in each partition before each epoch</span>
<span class="sd">                        when training</span>
<span class="sd">        :return: a TFDataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tensor_structure</span> <span class="o">=</span> <span class="n">TFDataset</span><span class="o">.</span><span class="n">_to_tensor_structure</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TFTextDataset</span><span class="p">(</span><span class="n">text_set</span><span class="p">,</span> <span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                             <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="p">,</span>
                             <span class="n">validation_image_set</span><span class="p">,</span>
                             <span class="n">sequential_order</span><span class="o">=</span><span class="n">sequential_order</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">)</span></div>

<div class="viewcode-block" id="TFDataset.from_tfrecord_file"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset.from_tfrecord_file">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_tfrecord_file</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_per_thread</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">validation_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">sequential_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a TFDataset from tfrecord files.</span>
<span class="sd">        :param sc: The SparkContext</span>
<span class="sd">        :param file_path: comma seperated tfrecord file(s) path</span>
<span class="sd">        :param batch_size: the batch size, used for training, should be a multiple of</span>
<span class="sd">        total core num</span>
<span class="sd">        :param batch_per_thread: the batch size for each thread, used for inference or evaluation</span>
<span class="sd">        :param hard_code_batch_size: whether to hard code the batch_size into tensorflow graph,</span>
<span class="sd">        if True, the static size of the first dimension of the resulting tensors is</span>
<span class="sd">        batch_size/total_core_num (training) or batch_per_thread for inference; if False,</span>
<span class="sd">        it is None.</span>
<span class="sd">        :param validation_file_path: The tfrecord files used for validation</span>
<span class="sd">        :param sequential_order: whether to iterate the elements in the Dataset</span>
<span class="sd">                                 in sequential order when training.</span>
<span class="sd">        :param shuffle: whether to shuffle the elements in each partition before each epoch</span>
<span class="sd">                        when training</span>
<span class="sd">        :return: a TFDataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_format_class</span> <span class="o">=</span> <span class="s2">&quot;org.tensorflow.hadoop.io.TFRecordFileInputFormat&quot;</span>
        <span class="n">key_class</span> <span class="o">=</span> <span class="s2">&quot;org.apache.hadoop.io.BytesWritable&quot;</span>
        <span class="n">value_class</span> <span class="o">=</span> <span class="s2">&quot;org.apache.hadoop.io.NullWritable&quot;</span>
        <span class="n">bytes_rdd</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">newAPIHadoopFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">input_format_class</span><span class="p">,</span>
                                        <span class="n">keyClass</span><span class="o">=</span><span class="n">key_class</span><span class="p">,</span>
                                        <span class="n">valueClass</span><span class="o">=</span><span class="n">value_class</span><span class="p">)</span>
        <span class="n">bytes_rdd</span> <span class="o">=</span> <span class="n">bytes_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">record</span><span class="p">:</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">validation_bytes_rdd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">validation_file_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">validation_bytes_rdd</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">newAPIHadoopFile</span><span class="p">(</span><span class="n">validation_file_path</span><span class="p">,</span>
                                                       <span class="n">input_format_class</span><span class="p">,</span>
                                                       <span class="n">keyClass</span><span class="o">=</span><span class="n">key_class</span><span class="p">,</span>
                                                       <span class="n">valueClass</span><span class="o">=</span><span class="n">value_class</span><span class="p">)</span>
            <span class="n">validation_bytes_rdd</span> <span class="o">=</span> <span class="n">validation_bytes_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">record</span><span class="p">:</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">TFBytesDataset</span><span class="p">(</span><span class="n">bytes_rdd</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">batch_per_thread</span><span class="p">,</span>
                              <span class="n">hard_code_batch_size</span><span class="p">,</span> <span class="n">validation_bytes_rdd</span><span class="p">,</span>
                              <span class="n">sequential_order</span><span class="o">=</span><span class="n">sequential_order</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">)</span></div>

<div class="viewcode-block" id="TFDataset.from_feature_set"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset.from_feature_set">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_feature_set</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_per_thread</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">validation_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a TFDataset from a FeatureSet. Currently, the element in this Feature set must be a</span>
<span class="sd">        Sample, i.e. the result of ImageFeatureToSample transformer</span>
<span class="sd">        :param dataset: the feature set used to create this TFDataset</span>
<span class="sd">        :param features: a tuple of two, the first element is the type of this input feature,</span>
<span class="sd">        the second element is the shape of this element, i.e. (tf.float32, [224, 224, 3])).</span>
<span class="sd">        text can also be nested structure of this tuple of two.</span>
<span class="sd">        :param labels: a tuple of two, the first element is the type of label, the second element</span>
<span class="sd">        is the shape of this element, i.e. (tf.int32, [1])). label can also be nested structure of</span>
<span class="sd">        this tuple of two.</span>
<span class="sd">        :param batch_size: the batch size, used for training, should be a multiple of</span>
<span class="sd">        total core num</span>
<span class="sd">        :param batch_per_thread: the batch size for each thread, used for inference or evaluation</span>
<span class="sd">        :param hard_code_batch_size: whether to hard code the batch_size into tensorflow graph,</span>
<span class="sd">        if True, the static size of the first dimension of the resulting tensors is</span>
<span class="sd">        batch_size/total_core_num (training) or batch_per_thread for inference; if False,</span>
<span class="sd">        it is None.</span>
<span class="sd">        :param validation_dataset: The FeatureSet used for validation during training</span>
<span class="sd">        :return: a TFDataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tensor_structure</span> <span class="o">=</span> <span class="n">TFDataset</span><span class="o">.</span><span class="n">_to_tensor_structure</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TFFeatureDataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                                <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="p">,</span>
                                <span class="n">validation_dataset</span><span class="p">)</span></div>

<div class="viewcode-block" id="TFDataset.from_string_rdd"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset.from_string_rdd">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_string_rdd</span><span class="p">(</span><span class="n">string_rdd</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_per_thread</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">validation_string_rdd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a TFDataset from a RDD of strings. Each element is the RDD should be a single string.</span>
<span class="sd">        The returning TFDataset&#39;s feature_tensors has only one Tensor. the type of the Tensor</span>
<span class="sd">        is tf.string, and the shape is (None,). The returning don&#39;t have label_tensors. If the</span>
<span class="sd">        dataset is used for training, the label should be encoded in the string.</span>
<span class="sd">        :param string_rdd: the RDD of strings</span>
<span class="sd">        :param batch_size: the batch size, used for training, should be a multiple of</span>
<span class="sd">        total core num</span>
<span class="sd">        :param batch_per_thread: the batch size for each thread, used for inference or evaluation</span>
<span class="sd">        :param hard_code_batch_size: whether to hard code the batch_size into tensorflow graph,</span>
<span class="sd">        if True, the static size of the first dimension of the resulting tensors is</span>
<span class="sd">        batch_size/total_core_num (training) or batch_per_thread for inference; if False,</span>
<span class="sd">        it is None.</span>
<span class="sd">        :param validation_string_rdd: the RDD of strings to be used in validation</span>
<span class="sd">        :return: a TFDataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">string_rdd</span> <span class="o">=</span> <span class="n">string_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">validation_string_rdd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">validation_string_rdd</span> <span class="o">=</span> <span class="n">validation_string_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">TFBytesDataset</span><span class="p">(</span><span class="n">string_rdd</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">batch_per_thread</span><span class="p">,</span>
                              <span class="n">hard_code_batch_size</span><span class="p">,</span> <span class="n">validation_string_rdd</span><span class="p">)</span></div>

<div class="viewcode-block" id="TFDataset.from_bytes_rdd"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset.from_bytes_rdd">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_bytes_rdd</span><span class="p">(</span><span class="n">bytes_rdd</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_per_thread</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">validation_bytes_rdd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a TFDataset from a RDD of bytes. Each element is the RDD should be a bytes object.</span>
<span class="sd">        The returning TFDataset&#39;s feature_tensors has only one Tensor. the type of the Tensor</span>
<span class="sd">        is tf.string, and the shape is (None,). The returning don&#39;t have label_tensors. If the</span>
<span class="sd">        dataset is used for training, the label should be encoded in the bytes.</span>
<span class="sd">        :param bytes_rdd: the RDD of bytes</span>
<span class="sd">        :param batch_size: the batch size, used for training, should be a multiple of</span>
<span class="sd">        total core num</span>
<span class="sd">        :param batch_per_thread: the batch size for each thread, used for inference or evaluation</span>
<span class="sd">        :param hard_code_batch_size: whether to hard code the batch_size into tensorflow graph,</span>
<span class="sd">        if True, the static size of the first dimension of the resulting tensors is</span>
<span class="sd">        batch_size/total_core_num (training) or batch_per_thread for inference; if False,</span>
<span class="sd">        it is None.</span>
<span class="sd">        :param validation_bytes_rdd: the RDD of bytes to be used in validation</span>
<span class="sd">        :return: a TFDataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TFBytesDataset</span><span class="p">(</span><span class="n">bytes_rdd</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">batch_per_thread</span><span class="p">,</span>
                              <span class="n">hard_code_batch_size</span><span class="p">,</span> <span class="n">validation_bytes_rdd</span><span class="p">)</span></div>

<div class="viewcode-block" id="TFDataset.from_tf_data_dataset"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset.from_tf_data_dataset">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_tf_data_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">batch_per_thread</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">validation_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">sequential_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_checking</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a TFDataset from a tf.data.Dataset.</span>

<span class="sd">        The recommended way to create the dataset is to reading files in a shared file</span>
<span class="sd">        system (e.g. HDFS) that is accessible from every executor of this Spark Application.</span>

<span class="sd">        If the dataset is created by reading files in the local file system, then the</span>
<span class="sd">        files must exist in every executor in the exact same path. The path should be</span>
<span class="sd">        absolute path and relative path is not supported.</span>

<span class="sd">        A few kinds of dataset is not supported for now:</span>
<span class="sd">        1. dataset created from tf.data.Dataset.from_generators</span>
<span class="sd">        2. dataset with Dataset.batch operation.</span>
<span class="sd">        3. dataset with Dataset.repeat operation</span>
<span class="sd">        4. dataset contains tf.py_func, tf.py_function or tf.numpy_function</span>

<span class="sd">        :param dataset: the tf.data.Dataset</span>
<span class="sd">        :param batch_size: the batch size, used for training, should be a multiple of</span>
<span class="sd">        total core num</span>
<span class="sd">        :param batch_per_thread: the batch size for each thread, used for inference or evaluation</span>
<span class="sd">        :param hard_code_batch_size: whether to hard code the batch_size into tensorflow graph,</span>
<span class="sd">        if True, the static size of the first dimension of the resulting tensors is</span>
<span class="sd">        batch_size/total_core_num (training) or batch_per_thread for inference; if False,</span>
<span class="sd">        it is None.</span>
<span class="sd">        :param validation_dataset: the dataset used for validation</span>
<span class="sd">        :return: a TFDataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TFDataDataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">batch_per_thread</span><span class="p">,</span>
                             <span class="n">hard_code_batch_size</span><span class="p">,</span> <span class="n">validation_dataset</span><span class="p">,</span>
                             <span class="n">sequential_order</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">remove_checking</span><span class="p">)</span></div>

<div class="viewcode-block" id="TFDataset.from_dataframe"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataset.from_dataframe">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">,</span> <span class="n">labels_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">batch_per_thread</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">validation_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">sequential_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a TFDataset from a pyspark.sql.DataFrame.</span>

<span class="sd">        :param df: the DataFrame for the dataset</span>
<span class="sd">        :param feature_cols: a list of string, indicating which columns are used as features.</span>
<span class="sd">                            Currently supported types are FloatType, DoubleType, IntegerType,</span>
<span class="sd">                            LongType, ArrayType (value should be numbers), DenseVector</span>
<span class="sd">                            and SparseVector. For ArrayType, DenseVector and SparseVector,</span>
<span class="sd">                            the sizes are assume to the same.</span>
<span class="sd">        :param labels_cols: a list of string, indicating which columns are used as labels.</span>
<span class="sd">                            Currently supported types are FloatType, DoubleType, IntegerType,</span>
<span class="sd">                            LongType, ArrayType (value should be numbers), DenseVector</span>
<span class="sd">                            and SparseVector. For ArrayType, DenseVector and SparseVector,</span>
<span class="sd">                            the sizes are assume to the same.</span>
<span class="sd">        :param batch_size: the batch size, used for training, should be a multiple of</span>
<span class="sd">        total core num</span>
<span class="sd">        :param batch_per_thread: the batch size for each thread, used for inference or evaluation</span>
<span class="sd">        :param hard_code_batch_size: whether to hard code the batch_size into tensorflow graph,</span>
<span class="sd">        if True, the static size of the first dimension of the resulting tensors is</span>
<span class="sd">        batch_size/total_core_num (training) or batch_per_thread for inference; if False,</span>
<span class="sd">        it is None.</span>
<span class="sd">        :param validation_df: the DataFrame used for validation</span>
<span class="sd">        :return: a TFDataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DataFrameDataset</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">,</span> <span class="n">labels_cols</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                                <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="p">,</span> <span class="n">validation_df</span><span class="p">,</span>
                                <span class="n">sequential_order</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TFDataDataset"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataDataset">[docs]</a><span class="k">class</span> <span class="nc">TFDataDataset</span><span class="p">(</span><span class="n">TFDataset</span><span class="p">):</span>
<div class="viewcode-block" id="TFDataDataset.get_num_partitions"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataDataset.get_num_partitions">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_partitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># only called in inference case</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_core_num</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_assert_not_batched</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">tensorflow.python.data.ops</span> <span class="kn">import</span> <span class="n">dataset_ops</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">dataset_ops</span><span class="o">.</span><span class="n">DatasetV1Adapter</span><span class="p">):</span>
            <span class="n">TFDataDataset</span><span class="o">.</span><span class="n">_assert_not_batched</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">_dataset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">dataset_ops</span><span class="o">.</span><span class="n">BatchDataset</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dataset should not be batched,&quot;</span>
                             <span class="s2">&quot;please use a dataset without the batch operation&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_inputs</span><span class="p">():</span>
                <span class="n">TFDataDataset</span><span class="o">.</span><span class="n">_assert_not_batched</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

<div class="viewcode-block" id="TFDataDataset.check_rules"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFDataDataset.check_rules">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">check_rules</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="n">is_training</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">tensorflow.python.data.ops</span> <span class="kn">import</span> <span class="n">dataset_ops</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">dataset_ops</span><span class="o">.</span><span class="n">DatasetV1Adapter</span><span class="p">):</span>
            <span class="n">TFDataDataset</span><span class="o">.</span><span class="n">check_rules</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">_dataset</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="n">is_training</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rule</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">rule</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">is_training</span><span class="p">),</span> <span class="n">message</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_inputs</span><span class="p">():</span>
                    <span class="n">TFDataDataset</span><span class="o">.</span><span class="n">check_rules</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="n">is_training</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tf_data_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">validation_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sequential_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_checking</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">tensorflow.python.data.ops</span> <span class="kn">import</span> <span class="n">dataset_ops</span>
        <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

        <span class="c1"># rule 1: we assume that the dataset user passed is not batched</span>
        <span class="n">rules</span> <span class="o">=</span> <span class="p">[(</span>
            <span class="k">lambda</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">is_training</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">dataset_ops</span><span class="o">.</span><span class="n">BatchDataset</span><span class="p">),</span>
            <span class="s2">&quot;Dataset should not be batched, please use a dataset without the batch operation&quot;</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="k">lambda</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">is_training</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">dataset_ops</span><span class="o">.</span><span class="n">RepeatDataset</span><span class="p">),</span>
                <span class="s2">&quot;Dataset should not be repeated, please use a dataset without the repeat operation&quot;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">remove_checking</span><span class="p">:</span>
            <span class="n">TFDataDataset</span><span class="o">.</span><span class="n">check_rules</span><span class="p">(</span><span class="n">tf_data_dataset</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">validation_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">TFDataDataset</span><span class="o">.</span><span class="n">check_rules</span><span class="p">(</span><span class="n">validation_dataset</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">py_func_ops</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PyFunc&quot;</span><span class="p">,</span> <span class="s2">&quot;PyFuncStateless&quot;</span><span class="p">,</span> <span class="s2">&quot;EagerPyFunc&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_graph_def</span><span class="p">()</span><span class="o">.</span><span class="n">node</span><span class="p">:</span>
            <span class="n">op_type</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span>
            <span class="k">if</span> <span class="n">op_type</span> <span class="ow">in</span> <span class="n">py_func_ops</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tf.py_func, tf.py_function, tf.numpy_function and&quot;</span> <span class="o">+</span>
                                 <span class="s2">&quot; Dataset.from_generators are not supported in TFPark&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">tensorflow.python.keras.engine</span> <span class="kn">import</span> <span class="n">training_utils</span>
            <span class="n">training_utils</span><span class="o">.</span><span class="n">verify_dataset_shuffled</span><span class="p">(</span><span class="n">tf_data_dataset</span><span class="p">)</span>

        <span class="n">flatten_shapes</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">tf_data_dataset</span><span class="o">.</span><span class="n">output_shapes</span><span class="p">)</span>
        <span class="n">flatten_types</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">tf_data_dataset</span><span class="o">.</span><span class="n">output_types</span><span class="p">)</span>

        <span class="n">flatten_tensor_structure</span> <span class="o">=</span> <span class="p">[</span><span class="n">TensorMeta</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">flatten_types</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                               <span class="n">shape</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">flatten_shapes</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                                               <span class="n">name</span><span class="o">=</span><span class="s2">&quot;zoo_input_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flatten_shapes</span><span class="p">))]</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">tf_data_dataset</span><span class="o">.</span><span class="n">output_types</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">DType</span><span class="p">):</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="p">(</span><span class="n">structure</span><span class="p">,)</span>
        <span class="n">tensor_structure</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">pack_sequence_as</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span>
                                                 <span class="n">flatten_tensor_structure</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TFDataDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                                            <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_batch</span><span class="p">:</span>
            <span class="c1"># training case</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_per_partition_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_num</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shard_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_num</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_remainder</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># inference case</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_per_partition_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_per_thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shard_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_core_num</span>
            <span class="k">if</span> <span class="n">hard_code_batch_size</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drop_remainder</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;hard_code_batch_size is set to true, so we&quot;</span>
                                <span class="s2">&quot; must drop remainder elements in the dataset&quot;</span>
                                <span class="s2">&quot; to avoid outputting small batches, the dropped&quot;</span>
                                <span class="s2">&quot; elements will not get processed. You can &quot;</span>
                                <span class="s2">&quot;pad your dataset so that the total number &quot;</span>
                                <span class="s2">&quot;of elements is divisible by the total batch size&quot;</span>
                                <span class="s2">&quot; to avoid this.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drop_remainder</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hard_code_batch_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_remainder</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">tf_data_dataset</span> <span class="o">=</span> <span class="n">tf_data_dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_per_partition_batch_size</span><span class="p">,</span>
                                                <span class="n">drop_remainder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_remainder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validation_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">drop_remainder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hard_code_batch_size</span>
            <span class="n">validation_dataset</span> <span class="o">=</span> <span class="n">validation_dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_per_partition_batch_size</span><span class="p">,</span>
                                                          <span class="n">drop_remainder</span><span class="o">=</span><span class="n">drop_remainder</span><span class="p">)</span>

        <span class="n">shard_index</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">())</span>
        <span class="n">tf_data_dataset</span> <span class="o">=</span> <span class="n">tf_data_dataset</span><span class="o">.</span><span class="n">shard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shard_num</span><span class="p">,</span> <span class="n">shard_index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validation_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">validation_dataset</span> <span class="o">=</span> <span class="n">validation_dataset</span><span class="o">.</span><span class="n">shard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shard_num</span><span class="p">,</span> <span class="n">shard_index</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shard_index</span> <span class="o">=</span> <span class="n">shard_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">tf_data_dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">make_initializable_iterator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_next_ops</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_iterator</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">as_datatype_enum</span>
                             <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">output_types</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validation_dataset</span> <span class="o">=</span> <span class="n">validation_dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_iterator</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_next_ops</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_train_init_op_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_iterator</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_train_output_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_next_ops</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">validation_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_dataset</span><span class="o">.</span><span class="n">make_initializable_iterator</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_next_ops</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_iterator</span><span class="o">.</span><span class="n">get_next</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_val_init_op_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_iterator</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_val_output_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_next_ops</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table_init_name</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span> <span class="o">=</span> <span class="n">sequential_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_next_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_def</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">as_graph_def</span><span class="p">()</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_get_prediction_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">jvalue</span> <span class="o">=</span> <span class="n">callZooFunc</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;createMiniBatchRDDFromTFDataset&quot;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">graph_def</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_init_op_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_init_name</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_train_output_names</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">output_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shard_index</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="n">jvalue</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">toJavaRDD</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rdd</span>

    <span class="k">def</span> <span class="nf">_get_evaluation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">jvalue</span> <span class="o">=</span> <span class="n">callZooFunc</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;createMiniBatchRDDFromTFDatasetEval&quot;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">graph_def</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_init_op_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_init_name</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_train_output_names</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">output_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shard_index</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="n">jvalue</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">toJavaRDD</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rdd</span>

    <span class="k">def</span> <span class="nf">_get_training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">jvalue</span> <span class="o">=</span> <span class="n">callZooFunc</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;createTFDataFeatureSet&quot;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">graph_def</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_init_op_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_init_name</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_train_output_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shard_index</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FeatureSet</span><span class="p">(</span><span class="n">jvalue</span><span class="o">=</span><span class="n">jvalue</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_validation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jvalue</span> <span class="o">=</span> <span class="n">callZooFunc</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;createTFDataFeatureSet&quot;</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">graph_def</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val_init_op_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_init_name</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">_val_output_names</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">output_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shard_index</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">FeatureSet</span><span class="p">(</span><span class="n">jvalue</span><span class="o">=</span><span class="n">jvalue</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TFFeatureDataset"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFFeatureDataset">[docs]</a><span class="k">class</span> <span class="nc">TFFeatureDataset</span><span class="p">(</span><span class="n">TFDataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">validation_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TFFeatureDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                                               <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_dataset</span> <span class="o">=</span> <span class="n">validation_dataset</span>

    <span class="k">def</span> <span class="nf">_get_prediction_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;TFFeatureDataset is only supported in training&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_evaluation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;TFFeatureDataset is only supported in training&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">MergeFeatureLabelFeatureTransformer</span><span class="p">())</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">SampleToMiniBatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fs</span>

    <span class="k">def</span> <span class="nf">_get_validation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_dataset</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                <span class="n">MergeFeatureLabelFeatureTransformer</span><span class="p">())</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">SampleToMiniBatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">fs</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="TFFeatureDataset.get_num_partitions"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFFeatureDataset.get_num_partitions">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_partitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;TFFeatureDataset is only supported in training&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TFBytesDataset"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFBytesDataset">[docs]</a><span class="k">class</span> <span class="nc">TFBytesDataset</span><span class="p">(</span><span class="n">TFDataset</span><span class="p">):</span>
<div class="viewcode-block" id="TFBytesDataset.get_num_partitions"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFBytesDataset.get_num_partitions">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_partitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_rdd</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string_rdd</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">validation_string_rdd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sequential_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
        <span class="n">tensor_structure</span> <span class="o">=</span> <span class="p">(</span><span class="n">TensorMeta</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">),)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TFBytesDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                                             <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_rdd</span> <span class="o">=</span> <span class="n">string_rdd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_rdd</span> <span class="o">=</span> <span class="n">validation_string_rdd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span> <span class="o">=</span> <span class="n">sequential_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>

    <span class="k">def</span> <span class="nf">_get_prediction_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">jvalue</span> <span class="o">=</span> <span class="n">callZooFunc</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;createMiniBatchRDDFromStringRDD&quot;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">train_rdd</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">batch_per_thread</span><span class="p">)</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="n">jvalue</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">toJavaRDD</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rdd</span>

    <span class="k">def</span> <span class="nf">_get_evaluation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">jvalue</span> <span class="o">=</span> <span class="n">callZooFunc</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;createMiniBatchRDDFromStringRDD&quot;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">train_rdd</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">batch_per_thread</span><span class="p">)</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="n">jvalue</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">toJavaRDD</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rdd</span>

    <span class="k">def</span> <span class="nf">_get_training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">jvalue</span> <span class="o">=</span> <span class="n">callZooFunc</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;createMiniBatchFeatureSetFromStringRDD&quot;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">train_rdd</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">)</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureSet</span><span class="p">(</span><span class="n">jvalue</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fs</span>

    <span class="k">def</span> <span class="nf">_get_validation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_rdd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jvalue</span> <span class="o">=</span> <span class="n">callZooFunc</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;createMiniBatchFeatureSetFromStringRDD&quot;</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">validation_rdd</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">)</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureSet</span><span class="p">(</span><span class="n">jvalue</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fs</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TFTextDataset"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFTextDataset">[docs]</a><span class="k">class</span> <span class="nc">TFTextDataset</span><span class="p">(</span><span class="n">TFDataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text_set</span><span class="p">,</span> <span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">validation_text_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sequential_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TFTextDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                                            <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_set</span> <span class="o">=</span> <span class="n">text_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_text_set</span> <span class="o">=</span> <span class="n">validation_text_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span> <span class="o">=</span> <span class="n">sequential_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>

    <span class="k">def</span> <span class="nf">_get_prediction_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_set</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">sample</span><span class="p">:</span> <span class="n">Sample</span><span class="o">.</span><span class="n">from_jtensor</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
                                               <span class="n">labels</span><span class="o">=</span><span class="n">JTensor</span><span class="o">.</span><span class="n">from_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]))))</span>
        <span class="n">rdd_wrapper</span> <span class="o">=</span> <span class="n">callZooFunc</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;zooRDDSampleToMiniBatch&quot;</span><span class="p">,</span> <span class="n">rdd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_per_thread</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rdd_wrapper</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">toJavaRDD</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_evaluation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_set</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
        <span class="n">rdd_wrapper</span> <span class="o">=</span> <span class="n">callZooFunc</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;zooRDDSampleToMiniBatch&quot;</span><span class="p">,</span> <span class="n">rdd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_per_thread</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rdd_wrapper</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">toJavaRDD</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sample_rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_set</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">sample</span><span class="p">:</span> <span class="n">Sample</span><span class="o">.</span><span class="n">from_jtensor</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">features</span> <span class="o">+</span> <span class="n">sample</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                               <span class="n">labels</span><span class="o">=</span><span class="n">JTensor</span><span class="o">.</span><span class="n">from_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]))))</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureSet</span><span class="o">.</span><span class="n">sample_rdd</span><span class="p">(</span><span class="n">sample_rdd</span><span class="p">,</span>
                                   <span class="n">sequential_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span><span class="p">,</span>
                                   <span class="n">shuffle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">)</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">SampleToMiniBatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fs</span>

    <span class="k">def</span> <span class="nf">_get_validation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_text_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sample_rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_text_set</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">sample</span><span class="p">:</span> <span class="n">Sample</span><span class="o">.</span><span class="n">from_jtensor</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">features</span> <span class="o">+</span> <span class="n">sample</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                                   <span class="n">labels</span><span class="o">=</span><span class="n">JTensor</span><span class="o">.</span><span class="n">from_ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]))))</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureSet</span><span class="o">.</span><span class="n">sample_rdd</span><span class="p">(</span><span class="n">sample_rdd</span><span class="p">,</span>
                                       <span class="n">sequential_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span><span class="p">,</span>
                                       <span class="n">shuffle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">)</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">SampleToMiniBatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">fs</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="TFTextDataset.get_num_partitions"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFTextDataset.get_num_partitions">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_partitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_set</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TFImageDataset"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFImageDataset">[docs]</a><span class="k">class</span> <span class="nc">TFImageDataset</span><span class="p">(</span><span class="n">TFDataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">validation_image_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sequential_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TFImageDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                                             <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_set</span> <span class="o">=</span> <span class="n">image_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_image_set</span> <span class="o">=</span> <span class="n">validation_image_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span> <span class="o">=</span> <span class="n">sequential_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>

    <span class="k">def</span> <span class="nf">_get_prediction_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_set</span>

    <span class="k">def</span> <span class="nf">_get_evaluation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_set</span><span class="o">.</span><span class="n">to_image_frame</span><span class="p">()</span> \
            <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">MergeFeatureLabelImagePreprocessing</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_get_training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureSet</span><span class="o">.</span><span class="n">image_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_set</span><span class="p">,</span>
                                  <span class="n">sequential_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span><span class="p">,</span>
                                  <span class="n">shuffle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">)</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">MergeFeatureLabelImagePreprocessing</span><span class="p">())</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">ImageFeatureToSample</span><span class="p">())</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">SampleToMiniBatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">fs</span>

    <span class="k">def</span> <span class="nf">_get_validation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_image_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureSet</span><span class="o">.</span><span class="n">image_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_image_set</span><span class="p">,</span>
                                      <span class="n">sequential_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span><span class="p">,</span>
                                      <span class="n">shuffle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">)</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">MergeFeatureLabelImagePreprocessing</span><span class="p">())</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">ImageFeatureToSample</span><span class="p">())</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">SampleToMiniBatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">fs</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="TFImageDataset.get_num_partitions"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFImageDataset.get_num_partitions">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_partitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_set</span><span class="o">.</span><span class="n">get_image</span><span class="p">()</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TFParkSampleToMiniBatch"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFParkSampleToMiniBatch">[docs]</a><span class="k">class</span> <span class="nc">TFParkSampleToMiniBatch</span><span class="p">(</span><span class="n">Preprocessing</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     a Transformer that converts Feature to (Feature, None).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">drop_remainder</span><span class="p">,</span>
                 <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TFParkSampleToMiniBatch</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">bigdl_type</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="p">)</span></div>


<div class="viewcode-block" id="TFNdarrayDataset"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFNdarrayDataset">[docs]</a><span class="k">class</span> <span class="nc">TFNdarrayDataset</span><span class="p">(</span><span class="n">TFDataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdd</span><span class="p">,</span> <span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">val_rdd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sequential_order</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TFNdarrayDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                                               <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">val_rdd</span> <span class="o">=</span> <span class="n">val_rdd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rdd</span> <span class="o">=</span> <span class="n">rdd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span> <span class="o">=</span> <span class="n">sequential_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hard_code_batch_size</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;hard_code_batch_size is set to true, so we&quot;</span>
                            <span class="s2">&quot; must drop remainder elements in the dataset&quot;</span>
                            <span class="s2">&quot; to avoid outputting small batches, the dropped&quot;</span>
                            <span class="s2">&quot; elements will not get processed. You can &quot;</span>
                            <span class="s2">&quot;pad your dataset so that the total number &quot;</span>
                            <span class="s2">&quot;of elements is divisible by the total batch size&quot;</span>
                            <span class="s2">&quot; to avoid this.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_prediction_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">Sample</span><span class="o">.</span><span class="n">from_ndarray</span><span class="p">(</span><span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])))</span>
        <span class="n">rdd_wrapper</span> <span class="o">=</span> <span class="n">callZooFunc</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;zooRDDSampleToMiniBatch&quot;</span><span class="p">,</span> <span class="n">rdd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_per_thread</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">hard_code_batch_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rdd_wrapper</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">toJavaRDD</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_evaluation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">Sample</span><span class="o">.</span><span class="n">from_ndarray</span><span class="p">(</span><span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])))</span>
        <span class="n">rdd_wrapper</span> <span class="o">=</span> <span class="n">callZooFunc</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;zooRDDSampleToMiniBatch&quot;</span><span class="p">,</span> <span class="n">rdd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_per_thread</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">hard_code_batch_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rdd_wrapper</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">toJavaRDD</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sample_rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">Sample</span><span class="o">.</span><span class="n">from_ndarray</span><span class="p">(</span><span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])))</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureSet</span><span class="o">.</span><span class="n">sample_rdd</span><span class="p">(</span><span class="n">sample_rdd</span><span class="p">,</span>
                                   <span class="n">sequential_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span><span class="p">,</span>
                                   <span class="n">shuffle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">)</span>
        <span class="c1"># for training there won&#39;t be any remainder, the input to SampleToMiniBatch</span>
        <span class="c1"># will loop indefinitely</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">TFParkSampleToMiniBatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fs</span>

    <span class="k">def</span> <span class="nf">_get_validation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_rdd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sample_rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">Sample</span><span class="o">.</span><span class="n">from_ndarray</span><span class="p">(</span><span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])))</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureSet</span><span class="o">.</span><span class="n">sample_rdd</span><span class="p">(</span><span class="n">sample_rdd</span><span class="p">,</span>
                                       <span class="n">sequential_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span><span class="p">,</span>
                                       <span class="n">shuffle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">)</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">TFParkSampleToMiniBatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hard_code_batch_size</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">fs</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="TFNdarrayDataset.get_num_partitions"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFNdarrayDataset.get_num_partitions">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_partitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span></div>

<div class="viewcode-block" id="TFNdarrayDataset.from_rdd"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFNdarrayDataset.from_rdd">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_rdd</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shapes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_per_thread</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">val_rdd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sequential_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">feature_structure</span> <span class="o">=</span> <span class="n">_to_tensor_structure</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">label_structure</span> <span class="o">=</span> <span class="n">_to_tensor_structure</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
                <span class="n">tensor_structure</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature_structure</span><span class="p">,</span> <span class="n">label_structure</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">tensor_structure</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature_structure</span><span class="p">,)</span>

            <span class="k">return</span> <span class="n">TFNdarrayDataset</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="n">tensor_structure</span><span class="p">,</span>
                                    <span class="n">batch_size</span><span class="p">,</span> <span class="n">batch_per_thread</span><span class="p">,</span>
                                    <span class="n">hard_code_batch_size</span><span class="p">,</span> <span class="n">val_rdd</span><span class="p">,</span>
                                    <span class="n">sequential_order</span><span class="o">=</span><span class="n">sequential_order</span><span class="p">,</span>
                                    <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">shapes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">shapes</span><span class="p">:</span>
                <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">types</span><span class="p">:</span>
                <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
            <span class="n">tensor_structure</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
                <span class="n">tensor_structure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TensorMeta</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="n">shapes</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tensor_structure</span> <span class="o">=</span> <span class="p">[</span><span class="n">TensorMeta</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">TensorMeta</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">TFNdarrayDataset</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="n">tensor_structure</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="p">,</span> <span class="n">batch_per_thread</span><span class="p">,</span>
                                <span class="n">hard_code_batch_size</span><span class="p">,</span> <span class="n">val_rdd</span><span class="p">,</span>
                                <span class="n">sequential_order</span><span class="o">=</span><span class="n">sequential_order</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">)</span></div>

<div class="viewcode-block" id="TFNdarrayDataset.from_ndarrays"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.TFNdarrayDataset.from_ndarrays">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_ndarrays</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_per_thread</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">val_tensors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">sequential_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">getOrCreateSparkContext</span><span class="p">()</span>
        <span class="n">node_num</span><span class="p">,</span> <span class="n">core_num</span> <span class="o">=</span> <span class="n">get_node_and_core_number</span><span class="p">()</span>
        <span class="n">total_core_num</span> <span class="o">=</span> <span class="n">node_num</span> <span class="o">*</span> <span class="n">core_num</span>

        <span class="n">rdd</span><span class="p">,</span> <span class="n">tensor_structure</span> <span class="o">=</span> <span class="n">_tensors_to_rdd</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">total_core_num</span><span class="p">)</span>

        <span class="n">val_rdd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">val_tensors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val_rdd</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_tensors_to_rdd</span><span class="p">(</span><span class="n">val_tensors</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">total_core_num</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TFNdarrayDataset</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                                <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="p">,</span>
                                <span class="n">val_rdd</span><span class="p">,</span> <span class="n">sequential_order</span><span class="o">=</span><span class="n">sequential_order</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DataFrameDataset"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.DataFrameDataset">[docs]</a><span class="k">class</span> <span class="nc">DataFrameDataset</span><span class="p">(</span><span class="n">TFNdarrayDataset</span><span class="p">):</span>
<div class="viewcode-block" id="DataFrameDataset.df_datatype_to_tf"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.DataFrameDataset.df_datatype_to_tf">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">df_datatype_to_tf</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
        <span class="kn">import</span> <span class="nn">pyspark.sql.types</span> <span class="k">as</span> <span class="nn">df_types</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">df_types</span><span class="o">.</span><span class="n">FloatType</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">df_types</span><span class="o">.</span><span class="n">IntegerType</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">df_types</span><span class="o">.</span><span class="n">LongType</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">df_types</span><span class="o">.</span><span class="n">DoubleType</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">df_types</span><span class="o">.</span><span class="n">ArrayType</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">VectorUDT</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,))</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DataFrameDataset.is_scalar_type"><a class="viewcode-back" href="../../../zoo.tfpark.html#zoo.tfpark.tf_dataset.DataFrameDataset.is_scalar_type">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_scalar_type</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pyspark.sql.types</span> <span class="k">as</span> <span class="nn">df_types</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">df_types</span><span class="o">.</span><span class="n">FloatType</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">df_types</span><span class="o">.</span><span class="n">IntegerType</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">df_types</span><span class="o">.</span><span class="n">LongType</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">df_types</span><span class="o">.</span><span class="n">DoubleType</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">,</span> <span class="n">labels_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">batch_per_thread</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">validation_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sequential_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s2">&quot;feature_cols should be a list&quot;</span>
        <span class="k">if</span> <span class="n">labels_cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels_cols</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s2">&quot;label_cols should be a list&quot;</span>
        <span class="kn">import</span> <span class="nn">pyspark</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pyspark</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">labels_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels_cols</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">selected_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">feature_cols</span> <span class="o">+</span> <span class="n">labels_cols</span><span class="p">))</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">selected_df</span><span class="o">.</span><span class="n">schema</span>
        <span class="n">feature_meta</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">feature_col</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="n">feature_col</span><span class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">dataType</span>
            <span class="k">if</span> <span class="n">DataFrameDataset</span><span class="o">.</span><span class="n">df_datatype_to_tf</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;data type </span><span class="si">{}</span><span class="s2"> of col </span><span class="si">{}</span><span class="s2"> is not supported for now&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="n">tf_type</span><span class="p">,</span> <span class="n">tf_shape</span> <span class="o">=</span> <span class="n">DataFrameDataset</span><span class="o">.</span><span class="n">df_datatype_to_tf</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
            <span class="n">feature_meta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TensorMeta</span><span class="p">(</span><span class="n">tf_type</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">tf_shape</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">labels_cols</span><span class="p">:</span>
            <span class="n">label_meta</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">label_col</span> <span class="ow">in</span> <span class="n">labels_cols</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span>
                <span class="n">data_type</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">dataType</span>
                <span class="k">if</span> <span class="n">DataFrameDataset</span><span class="o">.</span><span class="n">df_datatype_to_tf</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;data type </span><span class="si">{}</span><span class="s2"> of col </span><span class="si">{}</span><span class="s2"> is not supported for now&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                <span class="n">tf_type</span><span class="p">,</span> <span class="n">tf_shape</span> <span class="o">=</span> <span class="n">DataFrameDataset</span><span class="o">.</span><span class="n">df_datatype_to_tf</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
                <span class="n">label_meta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TensorMeta</span><span class="p">(</span><span class="n">tf_type</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">tf_shape</span><span class="p">))</span>

            <span class="n">tensor_structure</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature_meta</span><span class="p">,</span> <span class="n">label_meta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tensor_structure</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature_meta</span><span class="p">,)</span>

        <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>

            <span class="k">def</span> <span class="nf">convert_for_cols</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
                <span class="kn">import</span> <span class="nn">pyspark.sql.types</span> <span class="k">as</span> <span class="nn">df_types</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                    <span class="n">feature_type</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dataType</span>
                    <span class="k">if</span> <span class="n">DataFrameDataset</span><span class="o">.</span><span class="n">is_scalar_type</span><span class="p">(</span><span class="n">feature_type</span><span class="p">):</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature_type</span><span class="p">,</span> <span class="n">df_types</span><span class="o">.</span><span class="n">ArrayType</span><span class="p">):</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">DenseVector</span><span class="p">):</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">SparseVector</span><span class="p">),</span> \
                            <span class="s2">&quot;unsupported field </span><span class="si">{}</span><span class="s2">, data </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">toArray</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="n">features</span> <span class="o">=</span> <span class="n">convert_for_cols</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">labels_cols</span><span class="p">:</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">convert_for_cols</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">labels_cols</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">features</span><span class="p">,)</span>

        <span class="n">rdd</span> <span class="o">=</span> <span class="n">selected_df</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">convert</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
        <span class="n">val_rdd</span> <span class="o">=</span> <span class="n">validation_df</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">convert</span><span class="p">(</span><span class="n">row</span><span class="p">))</span> <span class="k">if</span> <span class="n">validation_df</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DataFrameDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="n">tensor_structure</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                                               <span class="n">batch_per_thread</span><span class="p">,</span> <span class="n">hard_code_batch_size</span><span class="p">,</span>
                                               <span class="n">val_rdd</span><span class="p">,</span> <span class="n">sequential_order</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">analytics-zoo  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../tfpark.html" >zoo.tfpark</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Intel.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.4.
    </div>
  </body>
</html>